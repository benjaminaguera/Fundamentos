<!DOCTYPE html>
<html>
<head>
	<title>Practica 2</title>
	<meta charset="UTF-8" />
	<style>
		canvas {
			margin: 0px;
			padding: 0px;
			border: 1px solid #000000;
			background-color: lightgray;
		}
	</style>
</head>
<body>
	<div>
		<canvas id="lienzo1" width="1000" height="1000"></canvas>
	</div>
	<div>
        <p id="parrafoCell"></p>
	</div>
	<button type="button" id="boton1" onclick="PausarReanudar()">Reanudar</button>
    <div id="info"></div>
	<script>

    class Tabla {
        constructor(x, y) {
            this.celulas = [];

            // Crear matriz vacía
            for (let i = 0; i < x; i++) {
                this.celulas[i] = [];
                for (let j = 0; j < y; j++) {
                    this.celulas[i][j] = new cell();
                }
            }
        }

        checkSurroundings(x, y) {
            const c = this.celulas;
            let vivas = 0;
            let derecha = x + 1;
            if (derecha >= c.length) { derecha = 0; }
            let izquierda = x - 1;
            if (izquierda < 0) { izquierda = c.length - 1; }
            let arriba = y - 1;
            if (arriba < 0) { arriba = c[x].length - 1; }
            let abajo = y + 1;
            if (abajo >= c[x].length) { abajo = 0; }

            if (c[izquierda][arriba].estadoActual == true) { vivas++; }
            if (c[x][arriba].estadoActual == true) { vivas++; }
            if (c[derecha][arriba].estadoActual == true) { vivas++; }
            if (c[derecha][y].estadoActual == true) { vivas++; }
            if (c[derecha][abajo].estadoActual == true) { vivas++; }
            if (c[x][abajo].estadoActual == true) { vivas++; }
            if (c[izquierda][abajo].estadoActual == true) { vivas++; }
            if (c[izquierda][y].estadoActual == true) { vivas++; }

            return vivas;
        }

        comprobarEstadoTabla() {
            for (let i = 0; i < this.celulas.length; i++) {
                for (let j = 0; j < this.celulas[i].length; j++) {
                    let celulasVivas = this.checkSurroundings(i, j);
                    this.celulas[i][j].checkEstado(celulasVivas);   // Calculamos el siguiente estado de la celda
                }
            }
        }

        swapTabla() {
            for (let i = 0; i < this.celulas.length; i++) {
                for (let j = 0; j < this.celulas[i].length; j++) {
                    this.celulas[i][j].cambiarEstado();
                }
            }
        }

        swapTile(x, y) {
            this.celulas[parseInt(x)][parseInt(y)].estadoActual = !this.celulas[parseInt(x)][parseInt(y)].estadoActual;
        }

        pintar(contextoGrafico) {
            for (var y = 0; y < this.celulas[0].length; y++) {
                for (var x = 0; x < this.celulas.length; x++) {
                    if (this.celulas[x][y].estadoActual == true) {
                        contextoGrafico.fillStyle = "white";
                        contextoGrafico.fillRect(0 + cellSize * x, 0 + cellSize * y, cellSize, cellSize);
                    } else {
                        contextoGrafico.fillStyle = "black";
                        contextoGrafico.fillRect(0 + cellSize * x, 0 + cellSize * y, cellSize, cellSize);
                    }
                }
            }
        }
    }

    class cell {
        constructor() {
            this.estadoActual = false;        // Para ambos, false = muerta; true = viva
            this.estadoSiguiente = this.estadoActual;
            this.tiempoVivo = 0;
        }

        checkEstado(celulasVivas) {
            this.estadoSiguiente = this.estadoActual;
            if (this.estadoActual === false && celulasVivas === 3) {        // Células Muertas
                this.estadoSiguiente = true;
            }
            if (this.estadoActual === true && (celulasVivas < 2 || celulasVivas > 3)) {    // Células Vivas
                this.estadoSiguiente = false;
            }
        }

        cambiarEstado() {
            this.estadoActual = this.estadoSiguiente;
            if (this.estadoActual == true) {
                this.tiempoVivo++;
            } else {
                this.tiempoVivo = 0;
            }
        }
    }

        var contextoGrafico = document.getElementById('lienzo1').getContext('2d');
        var parrafoCell = document.getElementById('parrafoCell')
        var info = document.getElementById('info');

        const tamañoCanvas = 750;

        let ancho = parseInt(prompt("¿Cuántas células de ancho y alto quieres?"));
        while (isNaN(ancho) || ancho <= 0) {
            ancho = parseInt(prompt("Valor no válido (menor o igual que 0), prueba otra vez ¿cuántas células por lado?"));
        }

        let alto = ancho;

        // Calculamos automáticamente el tamaño de cada celda
        let cellSize = Math.floor(tamañoCanvas / ancho);
        var simulate = false;
        var pasos = 0;

    contextoGrafico.canvas.width = cellSize * ancho;
    contextoGrafico.canvas.height = cellSize * alto;

        var tabla = new Tabla(ancho, alto);
        var temporizador = setInterval(actualizarSimulacion, 100);

    function inicializaElem(cuadro) {
        cuadro.addEventListener("mousemove", manejaratongenerico, false);
        cuadro.addEventListener("click", manejaratongenerico, false);
    }

        function manejaratongenerico(e) {
            let x = parseInt(e.offsetX / cellSize);
            let y = parseInt(e.offsetY / cellSize);
            switch (e.type) {
                case "click":
                    tabla.swapTile(x, y);
                    //console.log("X:" + x + " Y: " + y + ", " + tabla.checkSurroundings(x, y));
                    tabla.pintar(contextoGrafico);
                    break;
                case "mousemove":
                    let texto = "Celula en " + x + ", " + y + " lleva " + tabla.celulas[x][y].tiempoVivo + " pasos viva.";
                    parrafoCell.innerHTML = texto;
            }
        }

    function PausarReanudar() {
        simulate = !simulate;
        if (simulate) {
            document.getElementById("boton1").innerHTML = "Pausar";
        } else {
            document.getElementById("boton1").innerHTML = "Reanudar";
        }
    }

        function actualizarSimulacion() {
            if (!simulate) return;

            tabla.comprobarEstadoTabla();
            tabla.swapTabla();
            tabla.pintar(contextoGrafico);

            pasos++;
            info.innerHTML = "Paso: " + pasos;
        }


    
        tabla.pintar(contextoGrafico);


        inicializaElem(document.getElementById('lienzo1'));



	</script>
</body>
</html>
